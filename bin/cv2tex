#!/usr/bin/env ruby

require "bundler/setup"
require 'redcarpet'

class CvRender < Redcarpet::Render::Base
  def header(text, level)
    case level
    when 1
      case text
      when 'Languages and Technologies'
        @state = :skills
        "\\end{edulist}\n\\section{Skills}\n\\begin{sklist}\n"
      when 'Employment'
        @state = :experience
        @jobs = 0
        "\\section{Experience}\n\\begin{joblist}\n"
      when 'Education'
        @state = :education
        "}\n\\end{joblist}\n\\section{Education}\n\\begin{edulist}\n"
      else
        raise "Can't parse NAME header'#{text}'" unless text =~ /^(.*)\s<(.*)>$/
        @name = $1
        @email = $2

        @state = :name
        nil
      end
    else
      case @state
      when :skills
        "\\sk{#{text}}"
      when :experience
        re = %r{
          ^
          (?<duration>[^,]*),\s*
          (?<title>[^,]*),\s*
          \\href\{(?<link>.*)\}
          \{(?<employer>.*)\}
          $
        }x

        r = text.match(re)
        raise "Can't parse JOB '#{text}'" unless r

        jobend = @jobs != 0 ? "}\n" : ""
        @jobs += 1

        "#{jobend}\\job{#{r[:duration]}}{#{r[:title]}}{#{r[:link]}}{#{r[:employer]}}{\n"
      when :education
        re = %r{
          ^
          (?<duration>.*),\s*
          \\href\{(?<link>.*)\}
          \{(?<university>.*)\}
          $
        }x

        r = text.match(re)
        raise "Can't parse EDUCATION '#{text}'" unless r

        "\\edu{#{r[:duration]}}{}{#{r[:link]}}{#{r[:university]}}"
      end
    end
  end

  def list_item(item, type)
    if @state == :skills
      "  \\par #{item}"
    else
      "  \\par -- #{item}"
    end
  end

  def list(contents, type)
    if @state == :skills
      "{\n#{contents}\n}"
    else
      "\n#{contents}\n"
    end
  end

  def link(link, title, content)
    link.gsub!(/&/, '\\\\&')
    link.gsub!(/%/, '\\\\%')

    "\\href{#{link}}{#{content}}"
  end

  def paragraph(text)
    case @state
    when :education
    "{#{text.strip}}\n"

    when :name
      info = text.split(/,\s+/)
      @phone = info.shift
      @address = info.join(', ')

      @state = :desc

      "\\mktitle{#{@name}}{#{@address}}{#{@phone}}{#{@email}}\n"
    else
      text.strip
    end
  end
end

markdown = Redcarpet::Markdown.new(CvRender)
puts '\documentclass{cv}'
puts
puts '\begin{document}'
puts markdown.render(STDIN.read.sub(/---[^-]*---/, ''))
puts '\end{sklist}'
puts '\end{document}'
